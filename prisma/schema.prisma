generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  DRIVER
}

enum VehicleType {
  CAR
  BIKE
}

enum VehicleStatus {
  AVAILABLE
  ASSIGNED
  MAINTENANCE
  INACTIVE
}

enum ContractStatus {
  ACTIVE
  PAUSED
  ENDED
}

enum FeeFrequency {
  DAILY
  WEEKLY
  MONTHLY
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  OVERDUE
}

enum DocType {
  DRIVER_PHOTO
  CERTIFIED_ID
  PROOF_OF_RESIDENCE
  LICENSE
  OTHER
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VerificationStatus {
  UNVERIFIED
  IN_REVIEW
  VERIFIED
  REJECTED
}

enum CostType {
  LICENSE
  SERVICE
  REPAIR
  TYRES
  INSURANCE
  FUEL
  FINES
  OTHER
}

enum MaintenanceStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum VehicleDocType {
  OWNERSHIP
  LICENSE
  ROADWORTHY
  INSURANCE
  SERVICE_HISTORY
  INVOICE
  OTHER
}

enum NotificationType {
  PASSWORD_CHANGED
  EMAIL_CHANGED
  PROFILE_UPDATED
  DOCUMENT_SUBMITTED
  DOCUMENT_APPROVED
  DOCUMENT_REJECTED
  VERIFICATION_COMPLETE
  VERIFICATION_REJECTED
  PAYMENT_DUE
  PAYMENT_OVERDUE
  PAYMENT_RECEIVED
  CONTRACT_CREATED
  CONTRACT_UPDATED
  VEHICLE_ASSIGNED
  MAINTENANCE_DUE
  COMPLIANCE_EXPIRING
  SETTINGS_CHANGED
  SYSTEM_ALERT
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model User {
  id       String  @id @default(cuid())
  name     String?
  email    String  @unique
  phone    String?
  password String?
  role     Role    @default(DRIVER)

  isEmailVerified Boolean @default(false)
  isActive        Boolean @default(true)

  activationToken   String?   @unique
  activationExpires DateTime?

  resetPasswordToken   String?   @unique
  resetPasswordExpires DateTime?

  emailChangePending String?

  driverProfile DriverProfile?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DriverProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  idNumber     String?
  addressLine1 String?
  addressLine2 String?
  city         String?
  province     String?
  postalCode   String?

  verificationStatus VerificationStatus @default(UNVERIFIED)
  verificationNote   String?
  completionPercent  Int                @default(0)

  lastLat        Float?
  lastLng        Float?
  lastAccuracy   Float?
  lastLocationAt DateTime?

  documents DriverDocument[]
  contracts RentalContract[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DriverDocument {
  id       String        @id @default(cuid())
  driverId String
  driver   DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)

  type      DocType
  fileUrl   String
  fileName  String?
  mimeType  String?
  sizeBytes Int?

  status     ReviewStatus @default(PENDING)
  reviewNote String?
  reviewedBy String?
  reviewedAt DateTime?

  createdAt DateTime @default(now())
}

model Vehicle {
  id     String        @id @default(cuid())
  type   VehicleType
  reg    String        @unique
  make   String
  model  String
  year   Int?
  status VehicleStatus @default(AVAILABLE)
  notes  String?

  compliance  VehicleCompliance?
  documents   VehicleDocument[]
  maintenance VehicleMaintenance[]
  costs       VehicleCost[]
  contracts   RentalContract[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VehicleCompliance {
  id        String  @id @default(cuid())
  vehicleId String  @unique
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  licenseExpiry    DateTime?
  insuranceExpiry  DateTime?
  roadworthyExpiry DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VehicleDocument {
  id        String         @id @default(cuid())
  vehicleId String
  vehicle   Vehicle        @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  type      VehicleDocType
  title     String?
  fileUrl   String
  fileName  String?
  mimeType  String?
  sizeBytes Int?

  issuedAt  DateTime?
  expiresAt DateTime?

  createdAt DateTime @default(now())

  @@index([vehicleId])
  @@index([type])
  @@index([expiresAt])
}

model VehicleMaintenance {
  id        String            @id @default(cuid())
  vehicleId String
  vehicle   Vehicle           @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  title       String
  description String?
  status      MaintenanceStatus @default(PLANNED)

  scheduledAt DateTime?
  completedAt DateTime?
  odometerKm  Int?

  estimatedCostCents Int?
  actualCostCents    Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vehicleId])
  @@index([status])
  @@index([scheduledAt])
}

model VehicleCost {
  id        String   @id @default(cuid())
  vehicleId String
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  type        CostType
  title       String?
  amountCents Int
  occurredAt  DateTime @default(now())

  vendor     String?
  notes      String?
  receiptUrl String?

  createdAt DateTime @default(now())

  @@index([vehicleId])
  @@index([type])
  @@index([occurredAt])
}

model RentalContract {
  id        String @id @default(cuid())
  driverId  String
  vehicleId String

  driver  DriverProfile @relation(fields: [driverId], references: [id])
  vehicle Vehicle       @relation(fields: [vehicleId], references: [id])

  feeAmountCents Int
  frequency      FeeFrequency
  dueWeekday     Int? // 0-6 for weekly (0=Sunday, 6=Saturday)
  dueDayOfMonth  Int? // 1-28 for monthly contracts
  startDate      DateTime
  endDate        DateTime?
  status         ContractStatus @default(ACTIVE)

  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([driverId])
  @@index([vehicleId])
}

model Payment {
  id         String         @id @default(cuid())
  contractId String
  contract   RentalContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  amountCents Int
  dueDate     DateTime
  status      PaymentStatus @default(PENDING)

  stripeSessionId String?   @unique
  paidAt          DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dueDate])
  @@index([status])
}

model AppSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt

  @@index([key])
}

model Notification {
  id        String               @id @default(cuid())
  userId    String               // who receives it (admin user)
  type      NotificationType
  priority  NotificationPriority @default(MEDIUM)

  title     String
  message   String
  link      String?
  read      Boolean              @default(false)
  readAt    DateTime?
  metadata  Json?

  createdAt DateTime             @default(now())

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@index([type])
}
