generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String         @id @default(cuid())
  name                 String?
  email                String         @unique
  phone                String?
  password             String?
  role                 Role           @default(DRIVER)
  isEmailVerified      Boolean        @default(false)
  isActive             Boolean        @default(true)
  activationToken      String?        @unique
  activationExpires    DateTime?
  resetPasswordToken   String?        @unique
  resetPasswordExpires DateTime?
  emailChangePending   String?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  driverProfile        DriverProfile?
}

model DriverProfile {
  id                 String             @id @default(cuid())
  userId             String             @unique
  idNumber           String?
  addressLine1       String?
  addressLine2       String?
  city               String?
  province           String?
  postalCode         String?
  verificationStatus VerificationStatus @default(UNVERIFIED)
  verificationNote   String?
  completionPercent  Int                @default(0)
  lastLat            Float?
  lastLng            Float?
  lastAccuracy       Float?
  lastLocationAt     DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  documents          DriverDocument[]
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  contracts          RentalContract[]
}

model DriverDocument {
  id         String        @id @default(cuid())
  driverId   String
  type       DocType
  fileUrl    String
  fileName   String?
  mimeType   String?
  sizeBytes  Int?
  status     ReviewStatus  @default(PENDING)
  reviewNote String?
  reviewedBy String?
  reviewedAt DateTime?
  createdAt  DateTime      @default(now())
  driver     DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)
}

model Vehicle {
  id          String               @id @default(cuid())
  type        VehicleType
  reg         String               @unique
  make        String
  model       String
  year        Int?
  status      VehicleStatus        @default(AVAILABLE)
  notes       String?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  contracts   RentalContract[]
  compliance  VehicleCompliance?
  costs       VehicleCost[]
  documents   VehicleDocument[]
  maintenance VehicleMaintenance[]
}

model VehicleCompliance {
  id               String    @id @default(cuid())
  vehicleId        String    @unique
  licenseExpiry    DateTime?
  insuranceExpiry  DateTime?
  roadworthyExpiry DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  vehicle          Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
}

model VehicleDocument {
  id        String         @id @default(cuid())
  vehicleId String
  type      VehicleDocType
  title     String?
  fileUrl   String
  fileName  String?
  mimeType  String?
  sizeBytes Int?
  issuedAt  DateTime?
  expiresAt DateTime?
  createdAt DateTime       @default(now())
  vehicle   Vehicle        @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([type])
  @@index([expiresAt])
}

model VehicleMaintenance {
  id                 String            @id @default(cuid())
  vehicleId          String
  title              String
  description        String?
  status             MaintenanceStatus @default(PLANNED)
  scheduledAt        DateTime?
  completedAt        DateTime?
  odometerKm         Int?
  estimatedCostCents Int?
  actualCostCents    Int?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  vehicle            Vehicle           @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([status])
  @@index([scheduledAt])
}

model VehicleCost {
  id          String   @id @default(cuid())
  vehicleId   String
  type        CostType
  title       String?
  amountCents Int
  occurredAt  DateTime @default(now())
  vendor      String?
  notes       String?
  receiptUrl  String?
  createdAt   DateTime @default(now())
  vehicle     Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([type])
  @@index([occurredAt])
}

model RentalContract {
  id                   String         @id @default(cuid())
  driverId             String
  vehicleId            String
  feeAmountCents       Int
  frequency            FeeFrequency
  dueWeekday           Int?
  dueDayOfMonth        Int?
  startDate            DateTime
  endDate              DateTime?
  status               ContractStatus @default(DRAFT)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  adminSignatureUrl    String?
  adminSignedAt        DateTime?
  driverSignatureUrl   String?
  driverSignedAt       DateTime?
  lockedAt             DateTime?
  sentToDriverAt       DateTime?
  signedPdfGeneratedAt DateTime?
  signedPdfUrl         String?
  termsHash            String?
  termsText            String?
  termsVersion         String         @default("v1")
  payments             Payment[]
  driver               DriverProfile  @relation(fields: [driverId], references: [id])
  vehicle              Vehicle        @relation(fields: [vehicleId], references: [id])

  @@index([driverId])
  @@index([vehicleId])
  @@index([status])
}

model Payment {
  id              String         @id @default(cuid())
  contractId      String
  amountCents     Int
  dueDate         DateTime
  status          PaymentStatus  @default(PENDING)
  stripeSessionId String?        @unique
  paidAt          DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  contract        RentalContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([dueDate])
  @@index([status])
}

model AppSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt

  @@index([key])
}

model Notification {
  id        String               @id @default(cuid())
  userId    String
  type      NotificationType
  priority  NotificationPriority @default(MEDIUM)
  title     String
  message   String
  link      String?
  read      Boolean              @default(false)
  readAt    DateTime?
  metadata  Json?
  createdAt DateTime             @default(now())

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@index([type])
}

enum Role {
  ADMIN
  DRIVER
}

enum VehicleType {
  CAR
  BIKE
}

enum VehicleStatus {
  AVAILABLE
  ASSIGNED
  MAINTENANCE
  INACTIVE
}

enum ContractStatus {
  DRAFT              // Created by admin, editable
  SENT               // Sent to driver for signature
  SENT_TO_DRIVER     // Legacy: same as SENT
  SIGNED_BY_DRIVER   // Driver signed and accepted terms
  DRIVER_SIGNED      // Legacy: same as SIGNED_BY_DRIVER
  ACTIVE             // Fully valid and active (can assign vehicle)
  PAUSED             // Temporarily paused
  ENDED              // Contract ended/terminated
  CANCELLED          // Cancelled before activation
  EXPIRED            // Contract expired
}

enum FeeFrequency {
  DAILY
  WEEKLY
  MONTHLY
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  OVERDUE
}

enum DocType {
  DRIVER_PHOTO
  CERTIFIED_ID
  PROOF_OF_RESIDENCE
  LICENSE
  OTHER
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VerificationStatus {
  UNVERIFIED
  IN_REVIEW
  VERIFIED
  REJECTED
}

enum CostType {
  LICENSE
  SERVICE
  REPAIR
  TYRES
  INSURANCE
  FUEL
  FINES
  OTHER
}

enum MaintenanceStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum VehicleDocType {
  OWNERSHIP
  LICENSE
  ROADWORTHY
  INSURANCE
  SERVICE_HISTORY
  INVOICE
  OTHER
}

enum NotificationType {
  PASSWORD_CHANGED
  EMAIL_CHANGED
  PROFILE_UPDATED
  DOCUMENT_SUBMITTED
  DOCUMENT_APPROVED
  DOCUMENT_REJECTED
  VERIFICATION_COMPLETE
  VERIFICATION_REJECTED
  PAYMENT_DUE
  PAYMENT_OVERDUE
  PAYMENT_RECEIVED
  CONTRACT_CREATED
  CONTRACT_UPDATED
  VEHICLE_ASSIGNED
  MAINTENANCE_DUE
  COMPLIANCE_EXPIRING
  SETTINGS_CHANGED
  SYSTEM_ALERT
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}
